<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>PLAY. CREATE. LIVE. â€” Edit Creators</title>

    <style>
        :root {
            --bg: #05060a;
            --card: #11131aee;
            --border: #ffffff20;
            --text: #eaeef6;
            --muted: #9aa3b2;
            --accent: #ffb457;
            --accent2: #ff8c37;
            --danger: #ff6b6b;
            --radius: 20px;
            --shadow: 0 10px 30px rgba(0, 0, 0, .35), inset 0 1px 0 rgba(255, 255, 255, .04);
        }

        * {
            box-sizing: border-box;
        }

        html,
        body {
            height: 100%;
        }

        body {
            margin: 0;
            font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Noto Sans JP", sans-serif;
            color: var(--text);
            background: radial-gradient(circle at 0% 0%, #1f2937, #020617 60%);
            overflow-x: hidden;
        }

        header {
            padding: 18px 22px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .title {
            font-weight: 700;
            letter-spacing: .08em;
            font-size: 14px;
        }

        .lockstate {
            font-size: 12px;
            color: #ffd9b8;
            margin-left: 8px;
        }

        .back-link {
            text-decoration: none;
            font-size: 12px;
            color: #cbd5f5;
            padding: 8px 14px;
            border-radius: 999px;
            border: 1px solid var(--border);
            background: linear-gradient(135deg, #ffffff12, #ffffff03);
        }

        .back-link:hover {
            box-shadow: 0 10px 20px rgba(0, 0, 0, .35);
        }

        .container {
            max-width: 1120px;
            margin: 0 auto;
            padding: 0 20px 40px;
            display: grid;
            grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.1fr);
            gap: 20px;
        }

        @media(max-width:900px) {
            .container {
                grid-template-columns: 1fr;
            }
        }

        .glass {
            border-radius: var(--radius);
            background: linear-gradient(135deg, #ffffff0f, #ffffff03);
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
            padding: 16px 18px 18px;
        }

        h2 {
            font-size: 13px;
            letter-spacing: .1em;
            text-transform: uppercase;
            margin: 0 0 8px;
        }

        .hint {
            font-size: 12px;
            color: var(--muted);
            margin-bottom: 10px;
        }

        .dropzone {
            position: relative;
            border: 1px dashed #ffb45777;
            border-radius: 16px;
            padding: 18px;
            text-align: center;
            transition: .2s border-color, .2s background;
            background: linear-gradient(180deg, #ffb45715, transparent);
            margin-bottom: 10px;
        }

        .dropzone.dragover {
            border-color: #ffb457cc;
            background: linear-gradient(180deg, #ffb45722, transparent);
        }

        .row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }

        @media(max-width:640px) {
            .row {
                grid-template-columns: 1fr;
            }
        }

        label {
            font-size: 11px;
            color: #c8d0dc;
            letter-spacing: .06em;
            text-transform: uppercase;
        }

        input[type="text"],
        textarea {
            width: 100%;
            margin-top: 4px;
            padding: 9px 10px;
            border-radius: 12px;
            border: 1px solid var(--border);
            background: #020617cc;
            color: var(--text);
            font-size: 13px;
            outline: none;
            transition: border .2s, box-shadow .2s;
        }

        textarea {
            min-height: 70px;
            resize: vertical;
        }

        input:focus,
        textarea:focus {
            border-color: #ffb457aa;
            box-shadow: 0 0 0 3px #ffb45730;
        }

        .btns {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
        }

        .btn {
            appearance: none;
            border-radius: 999px;
            border: 1px solid var(--border);
            background: linear-gradient(135deg, #ffffff22, #ffffff08);
            color: var(--text);
            padding: 8px 14px;
            font-size: 12px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn.primary {
            background: linear-gradient(135deg, #ffb457, #ff8c37);
            border: none;
            color: #111827;
            font-weight: 600;
        }

        .btn.danger {
            border-color: #ff6b6b77;
            background: linear-gradient(135deg, #ef444477, #b91c1c55);
            color: #fee2e2;
        }

        .btn:disabled {
            opacity: .5;
            cursor: not-allowed;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 8px;
            font-size: 12px;
        }

        thead {
            background: #020617cc;
        }

        th,
        td {
            padding: 6px 6px;
            border-bottom: 1px solid #1e293b;
        }

        th {
            text-align: left;
            font-weight: 500;
            color: #cbd5f5;
        }

        tr:hover td {
            background: #0b1220;
        }

        .badge-lock {
            font-size: 11px;
            color: #facc15;
        }
    </style>
</head>

<body>
    <header>
        <div>
            <span class="title">PLAY. CREATE. LIVE. â€” EDIT</span>
            <span class="lockstate" id="lockState">ğŸ”’ Locked</span>
        </div>
        <a href="index.html" class="back-link">â† Back to TOP</a>
    </header>

    <main class="container">
        <!-- FORM -->
        <section class="glass">
            <h2>CREATOR FORM</h2>
            <p class="hint">å‹•ç”»ã¨ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’ç™»éŒ²ã—ã¾ã™ã€‚ä¿å­˜ã¯ãƒ–ãƒ©ã‚¦ã‚¶å†…ï¼ˆIndexedDBï¼‰ã«ã®ã¿è¡Œã‚ã‚Œã¾ã™ã€‚</p>

            <div class="dropzone" id="videoDrop">
                <input id="videoInput" type="file" accept="video/*"
                    style="position:absolute;inset:0;opacity:0;cursor:pointer;">
                <div style="pointer-events:none">
                    <div style="font-size:32px">â¬†</div>
                    <div style="font-size:13px;margin-top:2px;">ã“ã“ã«ãƒ¡ã‚¤ãƒ³å‹•ç”»ã‚’ãƒ‰ãƒ­ãƒƒãƒ—</div>
                    <div class="hint">MP4 / MOV ãƒ» 16:9æ¨å¥¨ ãƒ» 500MBæœªæº€</div>
                </div>
            </div>

            <div class="row">
                <div>
                    <label for="name">æ°åï¼ˆCreator Nameï¼‰</label>
                    <input id="name" type="text" placeholder="ä¾‹ï¼šDaijiro Majima">
                </div>
                <div>
                    <label for="company">ä¼šç¤¾åï¼ˆCompanyï¼‰</label>
                    <input id="company" type="text" placeholder="ä¾‹ï¼šTOPPAN Inc.">
                </div>
            </div>

            <div class="row">
                <div>
                    <label for="url">URL</label>
                    <input id="url" type="text" placeholder="https://example.com">
                </div>
                <div>
                    <label for="videoTitle">å‹•ç”»ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆä»»æ„ï¼‰</label>
                    <input id="videoTitle" type="text" placeholder="ä¾‹ï¼šSpace-CX Showreel">
                </div>
            </div>

            <div style="margin-top:10px;">
                <label for="summary">æ¦‚è¦ / ã‚³ãƒ¡ãƒ³ãƒˆ</label>
                <textarea id="summary" placeholder="ã“ã®å‹•ç”»ã‚„ã‚¯ãƒªã‚¨ã‚¤ã‚¿ãƒ¼ã«ã¤ã„ã¦ã®ç°¡å˜ãªèª¬æ˜"></textarea>
            </div>

            <div style="margin-top:10px;">
                <label>ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»åƒï¼ˆä»»æ„ï¼‰</label>
                <div class="btns" style="margin-top:6px;">
                    <label class="btn" style="position:relative;overflow:hidden;">
                        ç”»åƒã‚’é¸æŠ
                        <input id="profileInput" type="file" accept="image/*"
                            style="position:absolute;inset:0;opacity:0;cursor:pointer;">
                    </label>
                    <span class="hint" id="profileHint">æœªé¸æŠ</span>
                </div>
            </div>

            <div class="btns">
                <button class="btn primary" id="saveBtn">ä¿å­˜ / è¿½åŠ </button>
                <button class="btn" id="clearBtn">å…¥åŠ›ã‚¯ãƒªã‚¢</button>
            </div>
            <p class="hint">â€» ä¿å­˜ãƒ»ç·¨é›†ãƒ»å‰Šé™¤ã«ã¯ãƒ­ãƒƒã‚¯è§£é™¤ï¼ˆãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼‰ãŒå¿…è¦ã§ã™ã€‚</p>
        </section>

        <!-- LIST & AUTH -->
        <section class="glass">
            <h2>CREATOR LIST</h2>
            <p class="hint">ç™»éŒ²æ¸ˆã¿ã®ã‚¯ãƒªã‚¨ã‚¤ã‚¿ãƒ¼ä¸€è¦§ã€‚ã‚¯ãƒªãƒƒã‚¯ã§ãƒ•ã‚©ãƒ¼ãƒ ã«èª­ã¿è¾¼ã¿ã€ä¸Šæ›¸ãä¿å­˜ã§ãã¾ã™ã€‚ <span class="badge-lock">ï¼ˆãƒ­ãƒƒã‚¯ä¸­ã¯èª­ã¿å–ã‚Šå°‚ç”¨ï¼‰</span></p>

            <div class="btns">
                <button class="btn" id="authBtn">ç®¡ç† / ãƒ­ãƒƒã‚¯è§£é™¤</button>
                <button class="btn" id="exportBtn" disabled>ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼ˆJSONï¼‰</button>
                <label class="btn" style="position:relative;overflow:hidden;">
                    ã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼ˆJSONï¼‰
                    <input id="importInput" type="file" accept="application/json"
                        style="position:absolute;inset:0;opacity:0;cursor:pointer;" disabled>
                </label>
                <button class="btn danger" id="deleteAll" disabled>å…¨å‰Šé™¤</button>
            </div>

            <table>
                <thead>
                    <tr>
                        <th style="width:40px;">ID</th>
                        <th>æ°å</th>
                        <th>ä¼šç¤¾å</th>
                        <th>URL</th>
                        <th style="width:70px;">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="tbody">
                    <tr>
                        <td colspan="5" style="text-align:center;padding:16px 0;color:#9ca3af;">ã¾ã ç™»éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</td>
                    </tr>
                </tbody>
            </table>
        </section>
    </main>

    <script>
        var DB_NAME = 'creatorsVoiceDB';
        var STORE = 'creators';
        var db;

        function openDB() {
            return new Promise(function (resolve, reject) {
                var req = indexedDB.open(DB_NAME, 2);
                req.onupgradeneeded = function (e) {
                    var db = e.target.result;
                    if (!db.objectStoreNames.contains(STORE)) {
                        var os = db.createObjectStore(STORE, { keyPath: 'id', autoIncrement: true });
                        os.createIndex('createdAt', 'createdAt', { unique: false });
                    }
                };
                req.onsuccess = function () { db = req.result; resolve(db); };
                req.onerror = function () { reject(req.error); };
            });
        }

        function addEntry(entry) {
            return new Promise(function (resolve, reject) {
                var tx = db.transaction(STORE, 'readwrite');
                tx.oncomplete = function () { resolve(); };
                tx.onerror = function () { reject(tx.error); };
                tx.objectStore(STORE).add(entry);
            });
        }
        function updateEntry(entry) {
            return new Promise(function (resolve, reject) {
                var tx = db.transaction(STORE, 'readwrite');
                tx.oncomplete = function () { resolve(); };
                tx.onerror = function () { reject(tx.error); };
                tx.objectStore(STORE).put(entry);
            });
        }
        function getAll() {
            return new Promise(function (resolve, reject) {
                var tx = db.transaction(STORE, 'readonly');
                var req = tx.objectStore(STORE).getAll();
                req.onsuccess = function () { resolve(req.result); };
                req.onerror = function () { reject(req.error); };
            });
        }
        function deleteById(id) {
            return new Promise(function (resolve, reject) {
                var tx = db.transaction(STORE, 'readwrite');
                tx.objectStore(STORE).delete(id);
                tx.oncomplete = function () { resolve(); };
                tx.onerror = function () { reject(tx.error); };
            });
        }
        function clearAll() {
            return new Promise(function (resolve, reject) {
                var tx = db.transaction(STORE, 'readwrite');
                tx.objectStore(STORE).clear();
                tx.oncomplete = function () { resolve(); };
                tx.onerror = function () { reject(tx.error); };
            });
        }

        function $(s) { return document.querySelector(s); }

        function fileToThumb(imageFile) {
            return new Promise(function (resolve, reject) {
                var url = URL.createObjectURL(imageFile);
                var img = new Image();
                img.onload = function () {
                    var canvas = document.createElement('canvas');
                    var size = 200;
                    canvas.width = size; canvas.height = size;
                    var ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, size, size);
                    var data = canvas.toDataURL('image/jpeg', 0.9);
                    URL.revokeObjectURL(url);
                    resolve(data);
                };
                img.onerror = function (e) {
                    URL.revokeObjectURL(url);
                    reject(e);
                };
                img.src = url;
            });
        }

        function blobToBase64(blob) {
            return new Promise(function (resolve, reject) {
                var r = new FileReader();
                r.onload = function () { resolve(r.result); };
                r.onerror = function () { reject(r.error); };
                r.readAsDataURL(blob);
            });
        }

        var HASH_KEY = 'cv_admin_hash';
        var unlocked = false;

        function sha256(text) {
            var enc = new TextEncoder().encode(text);
            return crypto.subtle.digest('SHA-256', enc).then(function (buf) {
                return Array.from(new Uint8Array(buf)).map(function (b) {
                    return b.toString(16).padStart(2, '0');
                }).join('');
            });
        }

        function setLockUI() {
            $('#lockState').textContent = unlocked ? 'ğŸ”“ Unlocked' : 'ğŸ”’ Locked';
            $('#saveBtn').disabled = false;
            $('#clearBtn').disabled = false;
            $('#exportBtn').disabled = !unlocked;
            $('#importInput').disabled = !unlocked;
            $('#deleteAll').disabled = !unlocked;
        }

        function handleAuth() {
            var has = localStorage.getItem(HASH_KEY);
            if (!has) {
                var p = prompt('åˆå›è¨­å®šï¼šç®¡ç†ç”¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆ4æ–‡å­—ä»¥ä¸Šï¼‰');
                if (!p || p.length < 4) { alert('4æ–‡å­—ä»¥ä¸Šã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
                var p2 = prompt('ç¢ºèªã®ãŸã‚ã€ã‚‚ã†ä¸€åº¦å…¥åŠ›ã—ã¦ãã ã•ã„');
                if (p !== p2) { alert('ä¸€è‡´ã—ã¾ã›ã‚“ã§ã—ãŸ'); return; }
                sha256(p).then(function (h) {
                    localStorage.setItem(HASH_KEY, h);
                    unlocked = true;
                    setLockUI();
                    alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¨­å®šã—ã€ãƒ­ãƒƒã‚¯è§£é™¤ã—ã¾ã—ãŸã€‚');
                });
            } else {
                var p2 = prompt('ç®¡ç†ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                if (!p2) return;
                sha256(p2).then(function (h2) {
                    if (h2 === has) {
                        unlocked = true;
                        setLockUI();
                    } else {
                        alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™ã€‚');
                    }
                });
            }
        }

        var currentVideoFile = null;
        var currentProfileFile = null;
        var editingEntry = null;

        function bindDnD() {
            var dz = $('#videoDrop');
            var input = $('#videoInput');
            var hint = dz.querySelector('.hint');

            function setDrag(on) {
                dz.classList.toggle('dragover', !!on);
            }

            ['dragenter', 'dragover'].forEach(function (ev) {
                dz.addEventListener(ev, function (e) {
                    e.preventDefault(); e.stopPropagation(); setDrag(true);
                });
            });
            ['dragleave', 'drop'].forEach(function (ev) {
                dz.addEventListener(ev, function (e) {
                    e.preventDefault(); e.stopPropagation(); setDrag(false);
                });
            });

            dz.addEventListener('drop', function (e) {
                var files = e.dataTransfer.files;
                var f = files && files[0];
                if (f && f.type.indexOf('video/') === 0) {
                    currentVideoFile = f;
                    hint.textContent = 'å‹•ç”»èª­ã¿è¾¼ã¿ä¸­... (' + f.name + ')';
                    setTimeout(function () { hint.textContent = 'é¸æŠä¸­: ' + f.name; }, 500);
                }
            });

            input.addEventListener('change', function (e) {
                var files = e.target.files;
                var f = files && files[0];
                if (f && f.type.indexOf('video/') === 0) {
                    currentVideoFile = f;
                    hint.textContent = 'å‹•ç”»èª­ã¿è¾¼ã¿ä¸­... (' + f.name + ')';
                    setTimeout(function () { hint.textContent = 'é¸æŠä¸­: ' + f.name; }, 500);
                }
            });
        }

        function clearForm() {
            $('#name').value = '';
            $('#company').value = '';
            $('#url').value = '';
            $('#videoTitle').value = '';
            $('#summary').value = '';
            $('#videoInput').value = '';
            $('#profileInput').value = '';
            $('#videoDrop').querySelector('.hint').textContent = 'MP4 / MOV ãƒ» 16:9æ¨å¥¨ ãƒ» 500MBæœªæº€';
            $('#profileHint').textContent = 'æœªé¸æŠ';
            currentVideoFile = null;
            currentProfileFile = null;
            editingEntry = null;
        }

        function flashSaveButton(message) {
            var btn = $('#saveBtn');
            var origText = btn.textContent;
            var origBg = btn.style.backgroundImage;
            btn.textContent = message || 'Saved!';
            btn.style.backgroundImage = 'linear-gradient(135deg,#22c55e,#16a34a)';
            setTimeout(function () {
                btn.textContent = origText;
                btn.style.backgroundImage = origBg || '';
            }, 900);
        }

        function saveEntry() {
            if (!unlocked) {
                alert('ä¿å­˜ã™ã‚‹ã«ã¯ã€Œç®¡ç† / ãƒ­ãƒƒã‚¯è§£é™¤ã€ã‹ã‚‰ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            var saveBtn = $('#saveBtn');
            var origText = saveBtn.textContent;
            saveBtn.textContent = 'ä¿å­˜ä¸­...';
            saveBtn.disabled = true;
            saveBtn.style.opacity = '0.7';

            (async function () {
                try {
                    var name = $('#name').value.trim();
                    var company = $('#company').value.trim();
                    var url = $('#url').value.trim();
                    var videoTitle = $('#videoTitle').value.trim();
                    var summary = $('#summary').value.trim();

                    if (!name) {
                        alert('æ°åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                        return;
                    }

                    var mainVideoBlob = null;
                    if (editingEntry && editingEntry.mainVideo) {
                        mainVideoBlob = editingEntry.mainVideo;
                    }
                    if (currentVideoFile) {
                        var buf = await currentVideoFile.arrayBuffer();
                        mainVideoBlob = new Blob([buf], { type: currentVideoFile.type });
                    }
                    if (!mainVideoBlob) {
                        alert('ãƒ¡ã‚¤ãƒ³å‹•ç”»ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                        return;
                    }

                    var profileThumb = null;
                    if (editingEntry && editingEntry.profileThumb) {
                        profileThumb = editingEntry.profileThumb;
                    }
                    if (currentProfileFile) {
                        profileThumb = await fileToThumb(currentProfileFile);
                    }

                    var entry = {
                        id: editingEntry ? editingEntry.id : undefined,
                        name: name,
                        company: company,
                        url: url,
                        videoTitle: videoTitle,
                        summary: summary,
                        profileThumb: profileThumb,
                        mainVideo: mainVideoBlob,
                        createdAt: editingEntry && editingEntry.createdAt ? editingEntry.createdAt : Date.now()
                    };

                    if (editingEntry) {
                        await updateEntry(entry);
                    } else {
                        delete entry.id;
                        await addEntry(entry);
                    }

                    clearForm();
                    await renderList();
                    flashSaveButton(editingEntry ? 'æ›´æ–°ã—ã¾ã—ãŸ' : 'ä¿å­˜ã—ã¾ã—ãŸ');
                } finally {
                    saveBtn.disabled = false;
                    saveBtn.style.opacity = '1';
                    saveBtn.textContent = origText;
                }
            })();
        }

        function renderList() {
            return getAll().then(function (list) {
                list.sort(function (a, b) { return (b.createdAt || 0) - (a.createdAt || 0); });
                var tbody = $('#tbody');
                tbody.innerHTML = '';

                if (!list.length) {
                    var tr = document.createElement('tr');
                    var td = document.createElement('td');
                    td.colSpan = 5;
                    td.style.textAlign = 'center';
                    td.style.padding = '16px 0';
                    td.style.color = '#9ca3af';
                    td.textContent = 'ã¾ã ç™»éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚';
                    tr.appendChild(td);
                    tbody.appendChild(tr);
                    return;
                }

                for (var i = 0; i < list.length; i++) {
                    var it = list[i];
                    var tr = document.createElement('tr');
                    tr.innerHTML =
                        '<td>' + it.id + '</td>' +
                        '<td>' + (it.name || '') + '</td>' +
                        '<td>' + (it.company || '') + '</td>' +
                        '<td style="max-width:220px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">' + (it.url || '') + '</td>' +
                        '<td><button class="btn" data-id="' + it.id + '" style="padding:4px 8px;font-size:11px;">ç·¨é›†</button></td>';
                    tbody.appendChild(tr);
                }
            });
        }

        function handleRowClick(e) {
            var id = e.target.getAttribute('data-id');
            if (!id) return;
            getAll().then(function (list) {
                var it = null;
                for (var i = 0; i < list.length; i++) {
                    if (String(list[i].id) === String(id)) { it = list[i]; break; }
                }
                if (!it) return;
                $('#name').value = it.name || '';
                $('#company').value = it.company || '';
                $('#url').value = it.url || '';
                $('#videoTitle').value = it.videoTitle || '';
                $('#summary').value = it.summary || '';
                $('#profileHint').textContent = it.profileThumb ? 'æ—¢å­˜ç”»åƒã‚ã‚Š' : 'æœªé¸æŠ';
                currentVideoFile = null;
                currentProfileFile = null;
                editingEntry = it;
            });
        }

        function exportJSON() {
            if (!unlocked) {
                alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ã«ã¯ãƒ­ãƒƒã‚¯è§£é™¤ãŒå¿…è¦ã§ã™ã€‚');
                return;
            }
            getAll().then(function (list) {
                return Promise.all(list.map(function (it) {
                    return blobToBase64(it.mainVideo).then(function (videoB64) {
                        return {
                            id: it.id,
                            name: it.name,
                            company: it.company,
                            url: it.url,
                            videoTitle: it.videoTitle,
                            summary: it.summary,
                            profileThumb: it.profileThumb,
                            createdAt: it.createdAt,
                            videoB64: videoB64,
                            mime: it.mainVideo.type
                        };
                    });
                }));
            }).then(function (payload) {
                var a = document.createElement('a');
                a.href = URL.createObjectURL(new Blob([JSON.stringify(payload)], { type: 'application/json' }));
                a.download = 'creators-' + new Date().toISOString().slice(0, 10) + '.json';
                a.click();
                URL.revokeObjectURL(a.href);
            });
        }

        function importJSONFile(file) {
            if (!unlocked) {
                alert('ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹ã«ã¯ãƒ­ãƒƒã‚¯è§£é™¤ãŒå¿…è¦ã§ã™ã€‚');
                return;
            }
            file.text().then(function (text) {
                var arr = JSON.parse(text);
                (function loop(i) {
                    if (i >= arr.length) {
                        renderList();
                        return;
                    }
                    var it = arr[i];
                    fetch(it.videoB64).then(function (res) { return res.blob(); }).then(function (videoBlob) {
                        return addEntry({
                            id: it.id,
                            name: it.name,
                            company: it.company,
                            url: it.url,
                            videoTitle: it.videoTitle,
                            summary: it.summary,
                            profileThumb: it.profileThumb,
                            createdAt: it.createdAt || Date.now(),
                            mainVideo: videoBlob
                        });
                    }).then(function () {
                        loop(i + 1);
                    });
                })(0);
            });
        }

        (function init() {
            openDB().then(function () {
                bindDnD();
                setLockUI();
                return renderList();
            }).then(function () {
                $('#authBtn').addEventListener('click', handleAuth);
                $('#saveBtn').addEventListener('click', saveEntry);
                $('#clearBtn').addEventListener('click', clearForm);

                $('#profileInput').addEventListener('change', function (e) {
                    var files = e.target.files;
                    var f = files && files[0];
                    if (f) {
                        currentProfileFile = f;
                        var hint = $('#profileHint');
                        hint.textContent = 'ç”»åƒèª­ã¿è¾¼ã¿ä¸­... (' + f.name + ')';
                        setTimeout(function () { hint.textContent = 'é¸æŠä¸­: ' + f.name; }, 500);
                    }
                });

                $('#exportBtn').addEventListener('click', exportJSON);
                $('#importInput').addEventListener('change', function (e) {
                    var files = e.target.files;
                    var f = files && files[0];
                    if (f) importJSONFile(f);
                    e.target.value = '';
                });

                $('#deleteAll').addEventListener('click', function () {
                    if (!unlocked) {
                        alert('å‰Šé™¤ã™ã‚‹ã«ã¯ãƒ­ãƒƒã‚¯è§£é™¤ãŒå¿…è¦ã§ã™ã€‚');
                        return;
                    }
                    if (!confirm('ã™ã¹ã¦ã®ã‚¯ãƒªã‚¨ã‚¤ã‚¿ãƒ¼ã‚’å‰Šé™¤ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) return;
                    clearAll().then(renderList);
                });

                $('#tbody').addEventListener('click', handleRowClick);
            });
        })();
    </script>
</body>

</html>